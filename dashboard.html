<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Student Report</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; display: none; }
        .container { max-width: 1000px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1, h3 { color: #007bff; }
        .header-info { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .header-buttons { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .logout-btn, .refresh-btn, .btn-export, .btn-reset { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; text-align: center; width: 100%; }
        .logout-btn { background-color: #dc3545; color: white; }
        .refresh-btn { background-color: #17a2b8; color: white; }
        .student-list-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        .student-list-table th, .student-list-table td { border: 1px solid #ddd; padding: 12px; text-align: left; word-wrap: break-word; }
        .student-list-table th { background-color: #f2f2f2; }
        .report-form-section { margin-top: 30px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #fafafa; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .form-grid .full-width { grid-column: 1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .report-form-section button { padding: 10px 20px; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; }
        #addReportForm button { background-color: #28a745; margin-top: 15px; }
        #reportStatusMessage { margin-top: 15px; font-weight: bold; }
        .report-controls { margin-top: 40px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; }
        .report-filters { display: flex; flex-direction: column; flex-wrap: wrap; gap: 15px; align-items: stretch; }
        .report-filters > div { width: 100%; }
        #clearReportFilterBtn { width: 100%; }
        #sendPdfBtn {
            background-color: #25D366;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #sendPdfBtn:hover {
            background-color: #128C7E;
        }
        #sendPdfBtn svg {
            width: 18px;
            height: 18px;
        }
        #activityCheckboxes { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; padding: 10px; background-color: #fff; border: 1px solid #ddd; border-radius: 4px; }
        #activityCheckboxes label { font-weight: normal; display: flex; align-items: center; }
        #activityCheckboxes input { width: auto; margin-right: 8px; }
        .btn-export { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background-color 0.2s ease; }
        .btn-export:hover { background-color: #0056b3; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); width: 90%; max-width: 600px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; color: #333; }
        .close-btn { color: #aaa; font-size: 30px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: black; }
        .modal-body { display: flex; flex-direction: column; gap: 10px; }
        .btn-reset { background-color: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s ease; }
        .btn-reset:hover { background-color: #5a6268; }
        #readStatusIndicator { position: fixed; bottom: 10px; right: 10px; background-color: #212529; color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-family: monospace; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); opacity: 0.8; transition: opacity 0.3s; }
        #readStatusIndicator:hover { opacity: 1; }
        #readStatusIndicator button { margin-left: 10px; padding: 2px 8px; font-size: 12px; cursor: pointer; }
        
        .report-table-container {
            overflow-x: auto;
        }
        .report-table { 
            width: 100%; 
            border-collapse: collapse;
            white-space: nowrap;
        }
        .report-table th, .report-table td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: left; 
            word-wrap: break-word;
        }
        .report-table th { background-color: #f2f2f2; }

        @media (min-width: 768px) {
            .header-info { flex-direction: row; align-items: center; }
            .header-buttons { flex-direction: row; width: auto; }
            .logout-btn, .refresh-btn, .btn-export, .btn-reset { width: auto; }
            .form-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .form-grid > div { flex: 1 1 200px; }
            .form-grid .full-width { grid-column: 1 / -1; }
            .report-filters { flex-direction: row; align-items: flex-end; gap: 20px; }
            .report-filters > div { width: auto; }
            #clearReportFilterBtn { width: auto; }
            #sendPdfBtn { width: auto; }
            #activityCheckboxes { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
            
            .report-table-container {
                overflow-x: unset;
            }
            .report-table { 
                display: table; 
                table-layout: fixed; 
                white-space: normal;
                width: 100%;
            }
            .report-table th, .report-table td {
                min-width: unset;
            }
            
            .report-table .col-sesi {
                width: 5%;
                text-align: center;
            }
            .report-table .col-siswa {
                width: 15%;
            }
            .report-table .col-level {
                width: 10%;
            }
            .report-table .col-tanggal {
                width: 10%;
            }
            .report-table .col-lesson {
                width: 15%;
            }
            .report-table .col-aktivitas {
                width: 25%;
            }
            .report-table .col-hasil {
                width: 20%;
            }
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div id="readStatusIndicator">Reads Sesi Ini: 0</div>
    <div class="container">
        <div class="header-info">
            <h1>Progress Student Report</h1>
            <div class="header-buttons">
                <button class="btn-export" onclick="window.openWhatsappSettings()">Pengaturan WhatsApp Templates</button>
                <button type="button" class="refresh-btn" id="refreshDataBtn">Refresh Data</button>
                <button type="button" class="logout-btn" onclick="window.logout()">Logout</button>
            </div>
        </div>
        <p>Selamat datang, <strong id="coachEmailDisplay">...</strong>.</p>
        <div style="margin-top: 30px;">
            <h3>Daftar Siswa Anda</h3>
            <div style="overflow-x:auto;">
                <table class="student-list-table">
                    <thead><tr><th>Nama Siswa</th><th>Level</th><th>Lesson Terakhir</th></tr></thead>
                    <tbody id="myStudentsTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="report-form-section">
            <h3>Input Progress Anak</h3>
            <form id="addReportForm"><div class="form-grid"><div><label for="studentSelectorForReport">Pilih Siswa</label><select id="studentSelectorForReport" required></select></div><div><label for="reportDate">Tanggal Aktivitas</label><input type="date" id="reportDate" required></div><div><label for="reportLevel">Level Siswa</label><input type="text" id="reportLevel" placeholder="Pilih siswa..." readonly required></div><div><label for="reportLessonSelector">Lesson</label><select id="reportLessonSelector" required></select></div><div class="full-width" id="activityCheckboxesContainer" style="display: none;"><label>Aktivitas yang Dilakukan</label><div id="activityCheckboxes"></div></div><div class="full-width"><label for="reportHasil">Hasil</label><textarea id="reportHasil" rows="2" required></textarea></div></div><button type="submit">Kirim Laporan</button><div id="reportStatusMessage"></div></form>
        </div>
        <div class="report-controls">
            <h3>Riwayat Progress Anak</h3>
            <div class="report-filters">
                <div><label for="reportFilterStudent">Filter Berdasarkan Siswa</label><select id="reportFilterStudent"></select></div>
                <div><label for="reportFilterLevel">Filter Berdasarkan Level</label><select id="reportFilterLevel"></select></div>
                <div><label for="reportSortBy">Urutkan Berdasarkan</label><select id="reportSortBy"><option value="timestamp">Tanggal Aktivitas</option><option value="submissionTimestamp">Tanggal Input</option></select></div>
                <div><button type="button" id="clearReportFilterBtn">Reset Filter</button></div>
                <div>
                    <button type="button" id="sendPdfBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="#ffffff" d="M380.9 97.1C339.4 55.4 283.4 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67-157.1zm-157 341.6c-33.2 0-65.3-9.3-94-26.8l-6.5-3.8-7.9 20.9-23.2 61a15.8 15.8 0 0 1-18.2 6.5l-2.4-1.5c-2.8-1.7-12-6.5-17.7-9.5-6.1-3.2-18.2-9.7-31-15.3-12.7-5.5-24-9.3-37-12.2-13-2.8-25.2-1.9-38.3 4.2-13.2 6.2-22.1 16.5-27.7 30.7s-6.3 32.1 0 49.3c6.3 17.2 18.2 33.3 33.7 44.9 15.6 11.6 34.3 20.3 56.4 25.7 22.2 5.4 46.1 8.2 71 8.2h.1c42.8 0 83.1-12.6 116.3-37.4 33.2-24.8 54.4-60.8 61.4-102.5 7-41.8 1.9-86.4-14.8-125.7-16.8-39.3-43.1-76.3-95.6-33.3-23.4-74-35.3-116.7-35.3zm-51.2 57.3l2.8-3.4c2.5-3.1 5.3-5.2 8.4-6.4 3.1-1.2 6.5-1.9 10.1-1.9h.1c4.5 0 8.8 1.1 12.9 3.2 4.1 2.1 7.7 5.1 10.8 9.1s5.6 8.9 7.4 14.3c1.9 5.4 2.8 11.1 2.8 17.1v.2c0 6.6-1 12.8-3.1 18.6-2.1 5.8-4.9 10.8-8.5 15.1-3.6 4.3-7.8 7.6-12.7 9.8-4.9 2.2-10.2 3.3-15.8 3.3h-7.1c-14.7 0-29.2-4.1-42.5-12.2-13.3-8.2-24.9-19.4-34.6-34.6zm-17.7 26.6c-4.4-4-9.3-7.2-14.8-9.7s-11.4-4-17.7-4c-6.3 0-12.3 1.3-17.7 4.1s-10.1 6.8-13.2 11.3-5.1 9.4-6.3 14.8c-1.2 5.4-1.9 11-1.9 16.9v.2c0-6.6 1.4-12.8 4.2-18.6-2.8-5.8-6.5-10.8-11.3-15.1-4.7-4.3-10.1-7.6-16.2-9.8-6.1-2.2-12.7-3.3-19.5-3.3h-7.1c-14.7 0-29.2-4.1-42.5-12.2-13.3-8.2-24.9-19.4-34.6-34.6z"/></svg>
                        Kirim Laporan PDF via WhatsApp
                    </button>
                </div>
            </div>
            <div class="report-table-container">
                <table class="report-table" id="reportTableForPdf"><thead><tr><th class="col-sesi">Sesi</th><th class="col-siswa">Siswa</th><th class="col-level">Level</th><th class="col-tanggal">Tanggal</th><th class="col-lesson">Lesson</th><th class="col-aktivitas">Aktivitas</th><th class="col-hasil">Hasil</th></tr></thead><tbody id="reportsTableBody"></tbody></table>
            </div>
        </div>
    </div>
    
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pengaturan Template WhatsApp</h3>
                <span class="close-btn" onclick="settingsModal.style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <p>Edit teks template di bawah ini. Gunakan placeholder <code>{nama_siswa}</code>, <code>{level_siswa}</code>, dan <code>{nomor_sesi}</code> untuk data dinamis.</p>
                <textarea id="whatsappTemplateTextarea" rows="10" style="width:100%;"></textarea>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; align-items: center; flex-direction: column; gap: 10px;">
                    <button class="btn-export" onclick="window.saveWhatsappTemplate()">Simpan Template</button>
                    <button class="btn-reset" onclick="window.resetWhatsappTemplate()">Reset ke Awal</button>
                </div>
                <div id="settingsStatusMessage" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, query, where, Timestamp, orderBy, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyBm3SkLLtl9LvczDDht-OQ6-R4OYLPYAJQ", authDomain: "progres-report-5d199.firebaseapp.com", projectId: "progres-report-5d199", storageBucket: "progres-report-5d199.firebasestorage.app", messagingSenderId: "363573365137", appId: "1:363573365137:web:98f32d5ff8fae05617b230", measurementId: "G-CPX04R69F5" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let sessionReadCount = 0;
        const readStatusElement = document.getElementById('readStatusIndicator');

        window.updateReadStatus = function() {
            if(readStatusElement) readStatusElement.innerHTML = `Reads Sesi Ini: ${sessionReadCount} <button onclick="window.resetReadCount()">Reset</button>`;
        }
        window.resetReadCount = function() {
            sessionReadCount = 0;
            window.updateReadStatus();
        }
        let currentCoachName = '';
        let kurikulum = {};
        let myStudents = [];
        let allMyReports = [];
        let currentlyDisplayedReports = [];
        let brandSettings = {};
        
        const defaultReportWhatsappTemplate = `Halo Bapak/Ibu, ini adalah laporan aktivitas harian sempoa untuk *{nama_siswa}*.
Laporan sesi ke *{nomor_sesi}* untuk level *{level_siswa}* sudah tersedia.
Mohon cek folder unduhan Anda untuk melihat laporan lengkap dalam format PDF.
Terima kasih.`;
        let whatsappTemplateText = defaultReportWhatsappTemplate;
        
        window.logout = function() {
            sessionStorage.clear();
            localStorage.clear();
            signOut(auth).then(() => { window.location.href = 'login.html'; });
        };
        const saveToCache = (key, data) => {
            sessionStorage.setItem(key, JSON.stringify({ timestamp: Date.now(), data: data }));
        };
        const loadFromCache = (key, maxAgeMinutes = 5) => {
            const item = sessionStorage.getItem(key);
            if (!item) return null;
            const cache = JSON.parse(item);
            if (Date.now() - cache.timestamp > maxAgeMinutes * 60 * 1000) {
                sessionStorage.removeItem(key);
                return null;
            }
            return cache.data;
        };
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.updateReadStatus();
                const docRef = doc(db, "users", user.email);
                const docSnap = await getDoc(docRef);
                sessionReadCount++; window.updateReadStatus();
                if (docSnap.exists() && docSnap.data().role === 'user' && docSnap.data().status !== 'disabled') {
                    document.body.style.display = 'block';
                    document.getElementById('coachEmailDisplay').textContent = user.email;
                    currentCoachName = docSnap.data().name || user.email;
                    document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                    
                    kurikulum = JSON.parse(localStorage.getItem('kurikulum'))?.data || await fetchCurriculum();
                    brandSettings = JSON.parse(localStorage.getItem('brandSettings'))?.data || await fetchBrandSettings();
                    const cachedData = loadFromCache('coachData');
                    if (cachedData) {
                        myStudents = cachedData.students;
                        allMyReports = cachedData.reports;
                    } else {
                        const data = await loadAllData(user.email);
                        myStudents = data.students;
                        allMyReports = data.reports;
                    }
                    await loadWhatsappTemplate();
                    populateUI();
                    setupEventListeners();
                } else {
                    alert("Akses ditolak.");
                    await signOut(auth);
                    window.location.href = 'login.html';
                }
            } else { 
                window.location.href = 'login.html'; 
            }
        });
        async function fetchCurriculum() {
            try {
                const querySnapshot = await getDocs(collection(db, "kurikulum"));
                sessionReadCount += querySnapshot.size; window.updateReadStatus();
                const data = {};
                querySnapshot.forEach(doc => { data[doc.id] = doc.data().lessons; });
                saveToCache('kurikulum', data);
                return data;
            } catch (error) { console.error("Gagal ambil kurikulum:", error); return {}; }
        }
        async function fetchBrandSettings() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "brand"));
                sessionReadCount++; window.updateReadStatus();
                const settings = docSnap.exists() ? docSnap.data() : {};
                saveToCache('brandSettings', settings);
                return settings;
            } catch (error) { console.error("Gagal ambil brand settings:", error); return {}; }
        }
        async function loadWhatsappTemplate() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "whatsapp_templates"));
                sessionReadCount++; window.updateReadStatus();
                if (docSnap.exists() && docSnap.data().reportProof) {
                    whatsappTemplateText = docSnap.data().reportProof;
                } else {
                    whatsappTemplateText = defaultReportWhatsappTemplate;
                }
            } catch (error) {
                console.error("Gagal memuat template WhatsApp:", error);
                whatsappTemplateText = defaultReportWhatsappTemplate;
            }
        }
        async function loadAllData(coachEmail) {
            try {
                const studentQuery = query(collection(db, "students"), where("coachEmail", "==", coachEmail), where("status", "==", "active"));
                const studentSnapshot = await getDocs(studentQuery);
                sessionReadCount += studentSnapshot.size;
                const reportQuery = query(collection(db, "reports"), where("coachEmail", "==", coachEmail));
                const reportSnapshot = await getDocs(reportQuery);
                sessionReadCount += reportSnapshot.size;
                window.updateReadStatus();
                const students = studentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const reports = reportSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const processedReports = processAndSortReports(reports);

                const dataToCache = { students, reports: processedReports };
                saveToCache('coachData', dataToCache);
                return dataToCache;
            } catch (error) {
                console.error("Gagal memuat data:", error);
                return { students: [], reports: [] };
            }
        }
        function processAndSortReports(reports) {
            if (!reports || reports.length === 0) return [];
            
            const groupedReports = reports.reduce((acc, report) => {
                const key = `${report.studentId}_${report.level}`;
                if (!acc[key]) acc[key] = [];
                acc[key].push(report);
                return acc;
            }, {});

            let processedReports = [];
            for (const key in groupedReports) {
                const group = groupedReports[key];
                group.sort((a, b) => {
                    const dateA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                    const dateB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                    return dateA - dateB;
                });
                group.forEach((report, index) => {
                    report.activityNumber = index + 1;
                    processedReports.push(report);
                });
            }

            return processedReports;
        }

        function populateUI() {
            populateStudentLists();
            applyReportFiltersAndRender();
        }
        function populateStudentLists() {
            const studentsTableBody = document.getElementById('myStudentsTableBody');
            // Menggunakan jQuery untuk Select2
            const studentSelector = $('#studentSelectorForReport');
            const reportFilterStudent = $('#reportFilterStudent');
            
            studentsTableBody.innerHTML = '';
            studentSelector.empty().append('<option value="">-- Pilih Siswa --</option>');
            reportFilterStudent.empty().append('<option value="">-- Semua Siswa --</option>');
            
            myStudents.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
                const lastLessonDisplay = student.lastLesson || 'Belum ada laporan';
                studentsTableBody.innerHTML += `<tr><td>${student.name}</td><td>${student.studentLevel || ''}</td><td>${lastLessonDisplay}</td></tr>`;
                studentSelector.append(`<option value="${student.id}">${student.name}</option>`);
                reportFilterStudent.append(`<option value="${student.id}">${student.name}</option>`);
            });

            // Inisialisasi Select2 pada dropdown
            studentSelector.select2({
                placeholder: "-- Pilih Siswa --",
                allowClear: true,
                width: '100%'
            });
            reportFilterStudent.select2({
                placeholder: "-- Semua Siswa --",
                allowClear: true,
                width: '100%'
            });
        }

        function applyReportFiltersAndRender() {
            const studentId = document.getElementById('reportFilterStudent').value;
            let level = document.getElementById('reportFilterLevel').value;
            let sortOption = document.getElementById('reportSortBy').value;
            let filteredReports = allMyReports;
            if (studentId) {
                filteredReports = filteredReports.filter(r => r.studentId === studentId);
                const levels = [...new Set(filteredReports.map(r => r.level))].filter(Boolean);
                const levelFilter = document.getElementById('reportFilterLevel');
                const currentLevelValue = levelFilter.value;
                levelFilter.innerHTML = '<option value="">-- Semua Level --</option>';
                levels.forEach(lvl => {
                    levelFilter.innerHTML += `<option value="${lvl}">${lvl}</option>`;
                });
                if (levels.includes(currentLevelValue)) {
                    levelFilter.value = currentLevelValue;
                } else {
                    level = ''; 
                }
            } else {
                document.getElementById('reportFilterLevel').innerHTML = '<option value="">-- Semua Level --</option>';
                level = ''; 
            }
            if (level) {
                filteredReports = filteredReports.filter(r => r.level === level);
            }
            window.renderReports(filteredReports, sortOption);
        }

        window.renderReports = function(reports, sortOption) {
            currentlyDisplayedReports = reports;
            const tableBody = document.getElementById('reportsTableBody');
            tableBody.innerHTML = '';
            if (!reports || reports.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">Tidak ada laporan yang cocok.</td></tr>';
                return;
            }
            const sortedReports = reports.sort((a, b) => {
                let sortValueA = 0;
                let sortValueB = 0;
                try {
                    sortValueA = a[sortOption] && a[sortOption].toDate ? a[sortOption].toDate().getTime() : (a[sortOption] ? new Date(a[sortOption]).getTime() : 0);
                    sortValueB = b[sortOption] && b[sortOption].toDate ? b[sortOption].toDate().getTime() : (b[sortOption] ? new Date(b[sortOption]).getTime() : 0);
                } catch (e) {
                    console.warn('Gagal mengurai tanggal. Menggunakan tanggal 0.');
                    sortValueA = a[sortOption] ? new Date(a[sortOption]).getTime() : 0;
                    sortValueB = b[sortOption] ? new Date(b[sortOption]).getTime() : 0;
                }
                return sortValueB - sortValueA;
            });
            
            sortedReports.forEach(report => {
                const date = report.timestamp && report.timestamp.toDate ? report.timestamp.toDate().toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }) : new Date(report.timestamp).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                tableBody.innerHTML += `<tr><td style="text-align: center;">${report.activityNumber || ''}</td><td>${report.siswa}</td><td>${report.level}</td><td>${date}</td><td>${report.lessonName || ''}</td><td>${report.lesson || ''}</td><td>${report.hasil}</td></tr>`;
            });
        }
        
        async function handleAddReport(e) {
            e.preventDefault();
            const statusMessageDiv = document.getElementById('reportStatusMessage');
            const studentSelector = document.getElementById('studentSelectorForReport');
            const studentId = studentSelector.value;
            if (!studentId) {
                statusMessageDiv.textContent = 'Harap pilih siswa terlebih dahulu.'; return;
            }
            const studentName = $(`#studentSelectorForReport option[value="${studentId}"]`).text();
            const lessonName = document.getElementById('reportLessonSelector').value;
            const reportDate = document.getElementById('reportDate').value;
            statusMessageDiv.textContent = 'Mengirim...';
            const checkedActivities = Array.from(document.querySelectorAll('#activityCheckboxes input:checked'))
                .map(cb => cb.value)
                .sort(); 
            const reportData = {
                siswa: studentName, studentId: studentId,
                level: document.getElementById('reportLevel').value,
                coach: currentCoachName, coachEmail: auth.currentUser.email,
                lessonName: lessonName,
                lesson: checkedActivities.join(', '), 
                hasil: document.getElementById('reportHasil').value,
                timestamp: Timestamp.fromDate(new Date(reportDate)),
                submissionTimestamp: Timestamp.now()
            };
            
            try {
                await addDoc(collection(db, "reports"), reportData);
                const studentDocRef = doc(db, "students", studentId);
                await updateDoc(studentDocRef, {
                    lastLesson: lessonName,
                    lastReportTimestamp: reportData.timestamp
                });
                statusMessageDiv.textContent = 'Laporan berhasil dikirim!';
                document.getElementById('addReportForm').reset();
                document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('activityCheckboxesContainer').style.display = 'none';
                sessionStorage.removeItem('coachData');
                const data = await loadAllData(auth.currentUser.email);
                myStudents = data.students;
                allMyReports = data.reports;
                populateUI();
            } catch (error) {
                statusMessageDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        function handleStudentSelectForReport(e) {
            const studentId = $(this).val();
            const levelInput = document.getElementById('reportLevel');
            const lessonSelector = document.getElementById('reportLessonSelector');
            const activityContainer = document.getElementById('activityCheckboxesContainer');
            levelInput.value = '';
            lessonSelector.innerHTML = '';
            activityContainer.style.display = 'none';
            if (!studentId) return;
            const student = myStudents.find(s => s.id === studentId);
            if (student && student.studentLevel) {
                const studentLevelValue = student.studentLevel;
                levelInput.value = studentLevelValue;
                const lessons = kurikulum[studentLevelValue];
                lessonSelector.innerHTML = '<option value="">-- Pilih Lesson --</option>';
                if (lessons) {
                    const sortedLessonKeys = Object.keys(lessons).sort((a, b) => (parseInt(a.split(' ')[1]) || 0) - (parseInt(b.split(' ')[1]) || 0));
                    sortedLessonKeys.forEach(lessonKey => {
                        if (lessons[lessonKey] && lessons[lessonKey].length > 0) {
                            lessonSelector.innerHTML += `<option value="${lessonKey}">${lessonKey}</option>`;
                        }
                    });
                }
            }
        }
        
        function handleLessonSelect(e) {
            const lessonName = e.target.value;
            const level = document.getElementById('reportLevel').value;
            const container = document.getElementById('activityCheckboxesContainer');
            const checkboxes = document.getElementById('activityCheckboxes');
            checkboxes.innerHTML = '';
            if (!lessonName || !level || !kurikulum[level]) { container.style.display = 'none'; return; }
            
            const activities = kurikulum[level][lessonName].sort();
            if (activities && activities.length > 0) {
                activities.forEach(activity => {
                    checkboxes.innerHTML += `<label><input type="checkbox" value="${activity}" checked> ${activity}</label>`;
                });
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        let isSetupDone = false;
        function setupEventListeners() {
            if (isSetupDone) return;
            document.getElementById('refreshDataBtn').addEventListener('click', async () => {
                sessionStorage.clear();
                const data = await loadAllData(auth.currentUser.email);
                myStudents = data.students;
                allMyReports = data.reports;
                populateUI();
            });
            document.getElementById('addReportForm').addEventListener('submit', handleAddReport);
            
            // Gunakan event Select2
            $('#studentSelectorForReport').on('select2:select', handleStudentSelectForReport);
            
            document.getElementById('reportLessonSelector').addEventListener('change', handleLessonSelect);
            
            // Gunakan event Select2
            $('#reportFilterStudent').on('change', applyReportFiltersAndRender);
            
            document.getElementById('reportFilterLevel').addEventListener('change', applyReportFiltersAndRender);
            document.getElementById('reportSortBy').addEventListener('change', applyReportFiltersAndRender);
            document.getElementById('clearReportFilterBtn').addEventListener('click', () => {
                // Reset Select2
                $('#reportFilterStudent').val(null).trigger('change');
                document.getElementById('reportFilterLevel').innerHTML = '<option value="">-- Semua Level --</option>';
                document.getElementById('reportSortBy').value = 'timestamp';
                applyReportFiltersAndRender();
            });
            document.getElementById('sendPdfBtn').addEventListener('click', window.generatePdfAndWhatsApp);
            const settingsBtn = document.querySelector('.header-buttons .btn-export');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', window.openWhatsappSettings);
            }
            document.querySelector('#settingsModal .close-btn').onclick = () => document.getElementById('settingsModal').style.display = 'none';
            isSetupDone = true;
        }

        window.formatPhoneNumber = function(number) {
            if (typeof number !== 'string') {
                return '';
            }
            number = number.replace(/\s/g, '');
            if (number.startsWith('0')) {
                return '62' + number.slice(1);
            } else if (number.startsWith('+')) {
                return number.slice(1);
            }
            return number;
        };

        window.generatePdfAndWhatsApp = async function() {
            const studentFilter = document.getElementById('reportFilterStudent');
            const levelFilter = document.getElementById('reportFilterLevel');
            const studentId = studentFilter.value;
            if (!studentId || !levelFilter.value) {
                alert("Harap pilih filter Siswa dan Level spesifik terlebih dahulu sebelum membuat laporan.");
                return;
            }
            const student = myStudents.find(s => s.id === studentId);
            if (!student || !student.phone) {
                alert("Nomor telepon siswa tidak ditemukan. Harap perbarui data siswa di Panel Admin.");
                return;
            }
            const phoneNumber = window.formatPhoneNumber(student.phone);
            const isValidPhoneNumber = /^[0-9]{9,15}$/.test(phoneNumber);
            if (!isValidPhoneNumber) {
                alert("Nomor telepon siswa tidak valid. Harap perbarui data siswa di Panel Admin.");
                return;
            }
            if (currentlyDisplayedReports.length === 0) {
                alert("Tidak ada laporan untuk dibuat PDF.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const studentName = student.name;
            const levelName = levelFilter.options[levelFilter.selectedIndex].text;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageCenter = pageWidth / 2;
            let yPos = 15;
            
            const addContentAndSave = () => {
                if (brandSettings && brandSettings.companyName) {
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "normal");
                    doc.text(brandSettings.companyName, pageCenter, yPos, { align: "center" });
                    yPos += 8;
                }
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text("Laporan Aktivitas Siswa", pageCenter, yPos, { align: "center" });
                yPos += 15;
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Coach : ${currentCoachName}`, 15, yPos);
                doc.text(`Siswa / Level : ${studentName} / ${levelName}`, 15, yPos + 7);
                yPos += 15;
                const sortedReports = currentlyDisplayedReports.sort((a, b) => {
                    const dateA = a.timestamp && typeof a.timestamp.toDate === 'function' ? a.timestamp.toDate() : new Date(a.timestamp);
                    const dateB = b.timestamp && typeof b.timestamp.toDate === 'function' ? b.timestamp.toDate() : new Date(b.timestamp);
                    return dateB - dateA;
                });
                
                const reportsWithSessionNumbers = sortedReports.map((report, index) => ({
                    ...report,
                    activityNumber: currentlyDisplayedReports.length - index
                }));

                const head = [['Sesi', 'Tanggal', 'Lesson', 'Aktivitas', 'Hasil']];
                const body = reportsWithSessionNumbers.map(report => {
                    const date = (report.timestamp && typeof report.timestamp.toDate === 'function' ? report.timestamp.toDate() : new Date(report.timestamp)).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    return [ report.activityNumber, date, report.lessonName, report.lesson, report.hasil ];
                });
                doc.autoTable({
                    startY: yPos,
                    head: head,
                    body: body,
                    styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                    headStyles: { fillColor: [220, 220, 220], textColor: [0,0,0], fontStyle: 'bold' },
                    columnStyles: {
                        0: { cellWidth: 10 }, 1: { cellWidth: 20 }, 2: { cellWidth: 20 },
                        3: { cellWidth: 'auto' }, 4: { cellWidth: 'auto' }
                    },
                    margin: { left: 14, right: 14 }
                });

                const fileName = `Laporan_Aktivitas_${studentName.replace(/ /g, "_")}_${levelName.replace(/ /g, "_")}.pdf`;
                const lastReport = currentlyDisplayedReports.find(r => r.activityNumber === currentlyDisplayedReports.length);
                const lastSessionNumber = lastReport ? lastReport.activityNumber : 'N/A';
                
                let message = whatsappTemplateText
                    .replace(/{nama_siswa}/g, studentName)
                    .replace(/{level_siswa}/g, levelName)
                    .replace(/{nomor_sesi}/g, lastSessionNumber);

                const encodedMessage = encodeURIComponent(message);
                
                const isMobile = /Mobi|Android/i.test(navigator.userAgent);
                let whatsappUrl;
                if (isMobile) {
                    whatsappUrl = `whatsapp://send?phone=${phoneNumber}&text=${encodedMessage}`;
                } else {
                    whatsappUrl = `https://web.whatsapp.com/send/?phone=${phoneNumber}&text=${encodedMessage}&type=phone_number&app_absent=0`;
                }

                doc.save(fileName, { returnPromise: true }).then(() => {
                    alert(`Laporan PDF berhasil dibuat dan diunduh. Chat WhatsApp siap dikirim.`);
                    window.open(whatsappUrl, '_blank');
                });
            };

            if (brandSettings && brandSettings.logoBase64) {
                try {
                    const fullLogoBase64 = brandSettings.logoBase64.startsWith('data:') ? brandSettings.logoBase64 : `data:image/png;base64,${brandSettings.logoBase64}`;
                    const img = new Image();
                    img.src = fullLogoBase64;
                    img.onload = function() {
                        const desiredLogoHeight = 20;
                        const aspectRatio = img.width / img.height;
                        const calculatedLogoWidth = desiredLogoHeight * aspectRatio;
                        doc.addImage(fullLogoBase64, 'PNG', pageCenter - (calculatedLogoWidth / 2), yPos, calculatedLogoWidth, desiredLogoHeight, undefined, 'HIGH');
                        yPos += desiredLogoHeight + 10;
                        addContentAndSave();
                    };
                    img.onerror = function() {
                        console.error("Gagal memuat logo, lanjutkan tanpa logo.");
                        addContentAndSave();
                    };
                } catch (e) {
                    console.error("Gagal menambahkan logo ke PDF. Pastikan format Base64 benar.", e);
                    addContentAndSave();
                }
            } else {
                addContentAndSave();
            }
        };
        window.openWhatsappSettings = async function() {
            settingsModal.style.display = 'flex';
            settingsStatusMessage.textContent = 'Memuat template...';
            try {
                const docSnap = await getDoc(doc(db, "settings", "whatsapp_templates"));
                if (docSnap.exists() && docSnap.data().reportProof) {
                    whatsappTemplateTextarea.value = docSnap.data().reportProof;
                } else {
                    whatsappTemplateTextarea.value = defaultReportWhatsappTemplate;
                }
                settingsStatusMessage.textContent = '';
            } catch (error) {
                console.error("Gagal memuat template WhatsApp:", error);
                whatsappTemplateTextarea.value = defaultReportWhatsappTemplate;
                settingsStatusMessage.textContent = 'Gagal memuat template. Menggunakan default.';
                settingsStatusMessage.style.color = 'red';
            }
        };
        window.saveWhatsappTemplate = async function() {
            settingsStatusMessage.textContent = 'Menyimpan template...';
            settingsStatusMessage.style.color = 'blue';
            const newTemplateText = whatsappTemplateTextarea.value;
            try {
                const templateDocRef = doc(db, "settings", "whatsapp_templates");
                await updateDoc(templateDocRef, {
                    reportProof: newTemplateText,
                    lastUpdated: Timestamp.now()
                });
                whatsappTemplateText = newTemplateText;
                settingsStatusMessage.textContent = 'Template berhasil disimpan!';
                settingsStatusMessage.style.color = 'green';
            } catch (error) {
                console.error("Gagal menyimpan template:", error);
                settingsStatusMessage.textContent = `Error: ${error.message}`;
                settingsStatusMessage.style.color = 'red';
            }
        };
        window.resetWhatsappTemplate = function() {
            if (confirm("Apakah Anda yakin ingin mengembalikan template ke pengaturan awal?")) {
                whatsappTemplateTextarea.value = defaultReportWhatsappTemplate;
                window.saveWhatsappTemplate();
            }
        };
    </script>
</body>
</html>